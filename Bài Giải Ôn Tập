-- USE master
-- GO
-- DROP DATABASE QLDT
-- GO

create database QLDT
go
use QLDT
go
----------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------
create table GIAOVIEN 
(
	MAGV char (5), 
	HOTEN nvarchar(40), 
	LUONG float, 
	PHAI nchar(3), 
	NGSINH datetime,
	DIACHI nvarchar(100), 
	GVQLCM char(5), 
	MABM nchar(5)
	PRIMARY KEY (MAGV)
)

create table GV_DT 
(
	MAGV char(5), 
	DIENTHOAI char(12),
	PRIMARY KEY (MAGV, DIENTHOAI)
)

create table BOMON 
(
	MABM nchar(5),
	TENBM nvarchar(40), 	 
	PHONG char(5),
	DIENTHOAI char(12), 
	TRUONGBM char(5), 
	MAKHOA char(4), 	
	NGAYNHANCHUC datetime,
	PRIMARY KEY (MABM)
)
create table KHOA 
(
	MAKHOA char(4), 
	TENKHOA nvarchar(40), 
	NAMTL int, 
	PHONG char(5), 
	DIENTHOAI char(12), 	
	TRUONGKHOA char(5), 
	NGAYNHANCHUC datetime,
	PRIMARY KEY (MAKHOA)	
)

create table DETAI 
(
	MADT char(3), 
	TENDT nvarchar(100), 
	CAPQL nvarchar(40), 
	KINHPHI float, 
	NGAYBD datetime, 
	NGAYKT datetime, 	
	MACD nchar(4),
	GVCNDT char(5), 	
	PRIMARY KEY (MADT)
)

create table CHUDE 
(
	MACD nchar(4), 
	TENCD nvarchar(50),
	PRIMARY KEY (MACD)
)
create table CONGVIEC 
(
	MADT char(3), 
	SOTT int, 
	TENCV nvarchar(40), 
	NGAYBD datetime, 
	NGAYKT datetime,
	PRIMARY KEY (MADT, SOTT) 
)

create table THAMGIADT 
(
	MAGV char(5), 
	MADT char(3), 
	STT int, 
	PHUCAP float , 
	KETQUA nvarchar(40),
	PRIMARY KEY (MAGV, MADT, STT)
)

create table NGUOITHAN 
(
	MAGV char(5), 
	TEN nvarchar(20), 
	NGSINH datetime, 
	PHAI nchar(3),
	PRIMARY KEY (MAGV, TEN)
)

alter table GIAOVIEN add
	constraint FK_GIAOVIEN_BOMON foreign key (MABM) references BOMON (MABM),
	constraint FK_GIAOVIEN_GIAOVIEN foreign key (GVQLCM) references GIAOVIEN (MAGV)

alter table KHOA add 
	constraint FK_KHOA_GIAOVIEN foreign key (TRUONGKHOA) references GIAOVIEN (MAGV)

alter table BOMON add 
	constraint FK_BOMON_KHOA foreign key (MAKHOA) references KHOA(MAKHOA),
	constraint FK_BOMON_GIAOVIEN foreign key (TRUONGBM) references GIAOVIEN (MAGV)

alter table NGUOITHAN add
	constraint FK_NGUOITHAN_GIAOVIEN foreign key (MAGV)references GIAOVIEN (MAGV)

alter table THAMGIADT add
	constraint FK_PHANCONG_GIAOVIEN foreign key (MAGV)references GIAOVIEN (MAGV),
	constraint FK_PHANCONG_CONGVIEC foreign key (MADT, STT)references CONGVIEC(MADT, SOTT)

alter table DETAI add
	constraint FK_DETAI_CHUDE foreign key (MACD)references CHUDE (MACD)

alter table DETAI add
	constraint FK_DETAI_GIAOVIEN foreign key (GVCNDT)references GIAOVIEN (MAGV)

alter table GV_DT add
	constraint FK_DIENTHOAI_GIAOVIEN foreign key (MAGV)references GIAOVIEN (MAGV)

alter table CONGVIEC add 	
	constraint FK_CONGVIEC_DETAI foreign key (MADT)references DETAI (MADT)
----------------
insert into KHOA values ('CNTT',N'C√¥ng ngh·ªá th√¥ng tin',1995,'B11','0838123456',null,'02/20/2005')
insert into KHOA values ('VL',N'V·∫≠t l√Ω',1976,'B21','0838223223',null,'09/18/2003')
insert into KHOA values ('SH',N'Sinh h·ªçc',1980,'B31','0838454545',null,'10/11/2000')
insert into KHOA values ('HH',N'H√≥a h·ªçc',1980,'B41','0838456456',null,'10/15/2001')
----------------
insert into BOMON values (N'HTTT',N'H·ªá th·ªëng th√¥ng tin','B13','0838125125',null,'CNTT','09/20/2004')
insert into BOMON values (N'CNTT',N'C√¥ng ngh·ªá tri th·ª©c','B15','0838126126',null, 'CNTT', null)
insert into BOMON values (N'MMT',N'M·∫°ng m√°y t√≠nh','B16','0838676767 ',null,'CNTT','05/15/2005')
insert into BOMON values (N'VLƒêT',N'V·∫≠t l√Ω ƒëi·ªán t·ª≠','B23','0838234234',null, 'VL', null)	
insert into BOMON values (N'VL∆ØD',N'V·∫≠t l√Ω ·ª©ng d·ª•ng','B24','0838454545',null,'VL','02/18/2006')
insert into BOMON values (N'VS',N'Vi sinh','B32','0838909090',null,'SH','01/01/2007')
insert into BOMON values (N'SH',N'Sinh h√≥a','B33','0838898989',null, 'SH', null)	
insert into BOMON values (N'HL',N'H√≥a l√Ω','B42','0838878787',null, 'HH', null)	
insert into BOMON values (N'HPT',N'H√≥a ph√¢n t√≠ch','B43','0838777777',null,'HH','10/15/2007')
insert into BOMON values (N'HHC',N'H√≥a h·ªØu c∆°','B44','838222222',null, 'HH', null)	
----------------
insert into GIAOVIEN values ('001',N'Nguy·ªÖn Ho√†i An',2000,N'Nam','02/15/1973',N'25/3 L·∫°c Long Qu√¢n, Q.10, TP HCM', null, N'MMT')
insert into GIAOVIEN values ('002',N'Tr·∫ßn Tr√† H∆∞∆°ng',2500,N'N·ªØ','06/20/1960',N'125	Tr·∫ßn H∆∞ng ƒê·∫°o, Q.1,TP HCM', null, N'HTTT')
insert into GIAOVIEN values ('003',N'Nguy·ªÖn Ng·ªçc √Ånh',2200,N'N·ªØ','05/11/1975',N'12/21	V√µ VƒÉn Ng√¢n	Th·ªß ƒê·ª©c, TP HCM', '002',N'HTTT')
insert into GIAOVIEN values ('004',N'Tr∆∞∆°ng Nam S∆°n',2300,N'Nam','06/20/1959',N'215	L√Ω Th∆∞·ªùng Ki·ªát,TP Bi√™n H√≤a',null, N'VS')
insert into GIAOVIEN values ('005',N'L√Ω Ho√†ng H√†',2500,N'Nam','10/23/1954',N'22/5	Nguy·ªÖn X√≠, Q.B√¨nh Th·∫°nh, TP HCM',null, N'VLƒêT')
insert into GIAOVIEN values ('006',N'Tr·∫ßn B·∫°ch Tuy·∫øt',1500,N'N·ªØ','05/20/1980',N'127	H√πng V∆∞∆°ng, TP M·ªπ Tho','004',N'VS')
insert into GIAOVIEN values ('007',N'Nguy·ªÖn An Trung',2100,N'Nam','06/05/1976',N'234 3/2, TP Bi√™n H√≤a',null, N'HPT')
insert into GIAOVIEN values ('008',N'Tr·∫ßn Trung Hi·∫øu',1800,N'Nam','08/06/1977',N'22/11 L√Ω Th∆∞·ªùng Ki·ªát, TP M·ªπ Tho','007',N'HPT')
insert into GIAOVIEN values ('009',N'Tr·∫ßn Ho√†ng Nam',2000,N'Nam','11/22/1975',N'234	Tr·∫•n N√£o, An Ph√∫,TP HCM','001',N'MMT')
insert into GIAOVIEN values ('010',N'Ph·∫°m Nam Thanh',1500,N'Nam','12/12/1980',N'221	H√πng V∆∞∆°ng, Q.5, TP HCM','007',N'HPT')
----------------
insert into GV_DT values ('001','0903123123')
insert into GV_DT values ('001','0838912112')
insert into GV_DT values ('002','0913454545')
insert into GV_DT values ('003','0903656565')
insert into GV_DT values ('003','0838121212')
insert into GV_DT values ('003','0937125125')
insert into GV_DT values ('006','0937888888')
insert into GV_DT values ('008','0913232323')
insert into GV_DT values ('008','0653717171')
----------------
insert into CHUDE values (N'QLGD',N'Qu·∫£n l√Ω gi√°o d·ª•c')
insert into CHUDE values (N'NCPT',N'Nghi√™n c·ª©u ph√°t tri·ªÉn')
insert into CHUDE values (N'∆ØDCN',N'·ª®ng d·ª•ng c√¥ng ngh·ªá')
----------------
insert into DETAI (MADT, TENDT, KINHPHI, CAPQL, NGAYBD, NGAYKT, MACD, GVCNDT) values ('001',N'HTTT qu·∫£n l√Ω c√°c tr∆∞·ªùng ƒêH',20,N'ƒêHQG','10/20/2007','10/20/2008',N'QLGD','002')
insert into DETAI (MADT, TENDT, KINHPHI, CAPQL, NGAYBD, NGAYKT, MACD, GVCNDT) values ('002',N'HTTT qu·∫£n l√Ω gi√°o v·ª• cho m·ªôt Khoa','20',N'Tr∆∞·ªùng','10/12/2000','10/12/2001',N'QLGD','002')
insert into DETAI (MADT, TENDT, KINHPHI, CAPQL, NGAYBD, NGAYKT, MACD, GVCNDT) values ('003',N'Nghi√™n c·ª©u ch·∫ø t·∫°o s·ª£i Nan√¥ Platin','300',N'ƒêHQG','05/15/2008','05/15/2010',N'NCPT','005')
insert into DETAI (MADT, TENDT, KINHPHI, CAPQL, NGAYBD, NGAYKT, MACD, GVCNDT) values ('004',N'T·∫°o v·∫≠t li·ªáu sinh h·ªçc b·∫±ng m√†ng ·ªëi ng∆∞·ªùi','100',N'Nh√† n∆∞·ªõc','01/01/2007','12/31/2009',N'NCPT','004')
insert into DETAI (MADT, TENDT, KINHPHI, CAPQL, NGAYBD, NGAYKT, MACD, GVCNDT) values ('005',N'·ª®ng d·ª•ng h√≥a h·ªçc xanh','200',N'Tr∆∞·ªùng','10/10/2003','12/10/2004',N'∆ØDCN','007')
insert into DETAI (MADT, TENDT, KINHPHI, CAPQL, NGAYBD, NGAYKT, MACD, GVCNDT) values ('006',N'Nghi√™n c·ª©u t·∫ø b√†o g·ªëc','4000',N'Nh√† n∆∞·ªõc','10/20/2006','10/20/2009',N'NCPT','004')
insert into DETAI (MADT, TENDT, KINHPHI, CAPQL, NGAYBD, NGAYKT, MACD, GVCNDT) values ('007',N'HTTT qu·∫£n l√Ω th∆∞ vi·ªán ·ªü c√°c tr∆∞·ªùng ƒêH','20',N'Tr∆∞·ªùng','5/10/2009','05/10/2010',N'QLGD','001')
----------------
set dateformat dmy

insert into CONGVIEC values ('001',1,N'Kh·ªüi t·∫°o v√† L·∫≠p k·∫ø ho·∫°ch','20/10/2007','20/12/2008')
insert into CONGVIEC values ('001',2,N'X√°c ƒë·ªãnh y√™u c·∫ßu','21/12/2008','21/03/2008')
insert into CONGVIEC values ('001',3,N'Ph√¢n t√≠ch h·ªá th·ªëng','22/03/2008','22/5/2008')
insert into CONGVIEC values ('001',4,N'Thi·∫øt k·∫ø h·ªá th·ªëng','23/05/2008','23/06/2008')
insert into CONGVIEC values ('001',5,N'C√†i ƒë·∫∑t th·ª≠ nghi·ªám','24/06/2008','20/10/2008')
insert into CONGVIEC values ('006',1,N'L·∫•y m·∫´u','20/10/2006','20/02/2007')
insert into CONGVIEC values ('006',2,N'Nu√¥i c·∫•y','21/02/2007','21/08/2008')
insert into CONGVIEC values ('002',1,N'Kh·ªüi t·∫°o v√† L·∫≠p k·∫ø ho·∫°ch','10/05/2009','10/07/2009')
insert into CONGVIEC values ('002',2,N'X√°c ƒë·ªãnh y√™u c·∫ßu','11/07/2009','11/10/2009')
insert into CONGVIEC values ('002',3,N'Ph√¢n t√≠ch h·ªá th·ªëng','12/10/2009','20/12/2009')
insert into CONGVIEC values ('002',4,N'Thi·∫øt k·∫ø h·ªá th·ªëng','21/12/2009','22/03/2010')
insert into CONGVIEC values ('002',5,N'C√†i ƒë·∫∑t th·ª≠ nghi·ªám','23/03/2010','10/05/2010')
set dateformat mdy
----------------
insert into THAMGIADT values ('003','001',1,1,N'ƒê·∫°t')
insert into THAMGIADT values ('003','001',2,0,N'ƒê·∫°t')
insert into THAMGIADT values ('002','001',4,2,N'ƒê·∫°t')
insert into THAMGIADT values ('003','001',4,1,N'ƒê·∫°t')
insert into THAMGIADT values ('004','006',1,0,N'ƒê·∫°t')
insert into THAMGIADT values ('004','006',2,1,N'ƒê·∫°t')
insert into THAMGIADT values ('006','006',2,1.5,N'ƒê·∫°t')
insert into THAMGIADT values ('001','002',1,0, null)	
insert into THAMGIADT values ('001','002',2,2, null)	
insert into THAMGIADT values ('003','002',2,0, null)	
insert into THAMGIADT values ('009','002',3,0.5, null)	
insert into THAMGIADT values ('009','002',4,1.5, null)	
----------------
update KHOA set TRUONGKHOA = '002' where MAKHOA='CNTT'
update KHOA set TRUONGKHOA = '005' where MAKHOA='VL'
update KHOA set TRUONGKHOA = '004' where MAKHOA='SH'
update KHOA set TRUONGKHOA = '007' where MAKHOA='HH'
----------------
update BOMON set TRUONGBM = '002' where MABM=N'HTTT'
update BOMON set TRUONGBM = '001' where MABM=N'MMT'
update BOMON set TRUONGBM = '005' where MABM=N'VL∆ØD'
update BOMON set TRUONGBM = '004' where MABM=N'VS'
update BOMON set TRUONGBM = '007' where MABM=N'HPT'
----------------
insert into NGUOITHAN values ('001', N'H√πng', '1/14/1990', N'Nam')
insert into NGUOITHAN values ('001', N'Th·ªßy', '12/8/1994', N'N·ªØ')
insert into NGUOITHAN values ('003', N'Thu', '9/3/1998', N'N·ªØ')
insert into NGUOITHAN values ('003', N'H√†', '9/3/1998', N'N·ªØ')
insert into NGUOITHAN values ('008', N'Nam', '5/6/1991', N'Nam')
insert into NGUOITHAN values ('010', N'Nguy·ªát', '1/14/2006', N'N·ªØ')
insert into NGUOITHAN values ('007', N'Vy', '2/14/2000', N'N·ªØ')
insert into NGUOITHAN values ('007', N'Mai', '3/26/2003', N'N·ªØ')
insert into NGUOITHAN values ('009', N'An', '8/19/1996', N'Nam')


--C√¢u 1: Cho bi·∫øt m√£ v√† t√™n gi√°o vi√™n n√†o tham gia t·∫•t c·∫£ c√°c ƒë·ªÅ t√†i do Tr·∫ßn Tr√† H∆∞∆°ng l√†m ch·ªß nhi·ªám
SELECT GV.HOTEN,GV.MAGV  -- ƒë∆∞a ra th√¥ng tin gi√°o vi√™n
FROM GIAOVIEN GV
WHERE NOT EXISTS
(SELECT * 
FROM DETAI DT,THAMGIADT TGDT, GIAOVIEN TTH
WHERE DT.MADT=TGDT.MADT AND DT.GVCNDT=TTH.MAGV AND TTH.HOTEN=N'Tr·∫ßn Tr√† H∆∞∆°ng' --ch·ªçn ra ƒë·ªÅ t√†i TTH l√†m ch·ªß nhi·ªám
AND 
NOT EXISTS
(SELECT * 
FROM DETAI DT1,THAMGIADT TGDT1, GIAOVIEN TTH1
WHERE DT1.MADT=TGDT1.MADT AND DT1.GVCNDT=TTH1.MAGV AND TTH1.HOTEN=N'Tr·∫ßn Tr√† H∆∞∆°ng' AND GV.MAGV=TGDT1.MAGV AND TGDT1.MADT=TGDT.MADT)) -- ch·ªçn ra ƒë·ªÅ t√†i TTH l√†m ch·ªß nhi·ªám v√† li√™n k·∫øt v·ªõi tham gia ƒë·ªÅ t√†i vs gi√°o vi√™n trong select ban ƒë·∫ßu

-- C√¢u 2: Vi·∫øt v√† cho v√≠ d·ª• th·ª±c thi Store Procedure c√≥ t√™n l√† sp_PhanCong v·ªõi tham s·ªë ƒë·∫ßu
/*v√†o l√† MaGV, MaDT, STT v√† PhuCap. Th·ª±c hi·ªán c√¥ng vi·ªác th√™m m·ªôt d√≤ng v√†o b·∫£ng tham gia
ƒë·ªÅ t√†i v·ªõi c√°c y√™u c·∫ßu:
- Ki·ªÉm tra gi√°o vi√™n c√≥ t·ªìn t·∫°i kh√¥ng, ki·ªÉm tra MADT v√† STT c√≥ t·ªìn t·∫°i trong b·∫£ng CONGVIEC
hay kh√¥ng, n·∫øu kh√¥ng tr·∫£ v·ªÅ -1
- Ki·ªÉm tra b·ªô MaGV, MaDT, STT c√≥ t·ªìn t·∫°i trong b·∫£ng THANGIADT ch∆∞a, n·∫øu c√≥ print ra ‚Äúƒë√£
ph√¢n c√¥ng‚Äù v√† tr·∫£ v·ªÅ 0
- Vi·∫øt l·ªánh th√™m v√†o THAMGIADT v√† tr·∫£ v·ªÅ 1 n·∫øu th√†nh c√¥ng*/

create procedure sp_PhanCong (@maGv char(5), @maDt char(5), @stt int, @phuCap float)
as begin
	-- ki·ªÉm traq gi√°o vi√™n t·ªìn t·∫°i 
	if (not exists (
		select * from GIAOVIEN gv where gv.MAGV = @maGv
	))
		return -1

	-- ki·ªÉm tra m√£ ƒë·ªÅ t√†i + stt kh√¥ng t·ªìn t·∫°i trong b·∫£ng c√¥ng vi·ªác 
	if (not exists(
		select * from CONGVIEC cv where cv.MADT = @maDt and cv.SOTT = @stt
	))
		return -1

	-- ki·ªÉm tra b·ªô MaGV, MaDT, STT c√≥ t·ªìn t·∫°i trong b·∫£ng THANGIADT ch∆∞a
	if (exists(
		select * from THAMGIADT tg where tg.MADT = @maDt and tg.MAGV = @maGv and tg.STT = @stt
	)) 
	begin
		print N'ƒê√£ ph√¢n c√¥ng c√¥ng vi·ªác'
		return 0
	end

	insert THAMGIADT (MAGV, MADT, STT, PHUCAP) values (@maGv, @maDt, @stt, @phuCap)
end
exec sp_PhanCong '012', '001', 1, 12.1


/*C√¢u 3 (2.5ƒë). Vi·∫øt v√† cho v√≠ d·ª• th∆∞c thi Function c√≥ t√™n l√† fTinhPhuCap v·ªõi tham s·ªë v√†o l√†
MAGV tr·∫£ v·ªÅ t·ªïng ph·ª• c·∫•p c·ªßa gi√°o vi√™n ƒë√≥ khi tham gia ƒë·ªÅ t√†i v∆°i quy ƒë·ªãnh:
- Ki·ªÉm tra t·ªìn t·∫°i c·ªßa MAGV trong b·∫£ng THANGIADT, n·∫øu kh√¥ng t·ªìn t·∫°i tr·∫£ v·ªÅ -1
- Ch·ªâ t√≠nh ph·ª• c·∫•p tr√™n nh·ªØng c√¥ng vi·ªác c√≥ k·∫øt qu·∫£ =‚Äùƒê·∫°t‚Äù tr·∫£ v·ªÅ t·ªïng ph·ª• c·∫•p c·ªßa gi√°o vi√™n*/

alter function fTinhPhuCap(@MAGV varchar(5))
returns float 
as 
begin 
if(not exists (
select * from THAMGIADT tg where tg.MAGV=@MAGV))
begin
return -1
end
declare @tong float
set @tong =(select sum(tgdt.PHUCAP) from THAMGIADT tgdt where tgdt.KETQUA = N'ƒê·∫°t' and tgdt.MAGV=@MAGV )
return @tong
end

print dbo.fTinhPhuCap('003')
